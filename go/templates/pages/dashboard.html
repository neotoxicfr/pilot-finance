{{define "content"}}
<div class="w-full flex-1 p-4 md:p-8 max-w-[1600px] mx-auto space-y-8"
     x-data="{ sliderValue: {{.Years}} }">

    <input type="hidden" name="years" :value="sliderValue">

    <!-- KPI Cards -->
    <div id="kpi-cards"
         hx-get="/dashboard-partial?section=kpi"
         hx-trigger="sliderChange from:body"
         hx-vals="js:{years: document.querySelector('[name=years]')?.value || 5}"
         hx-swap="innerHTML">
        {{template "kpi-cards" .}}
    </div>

    <!-- Charts Section -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
        <!-- Projection Chart -->
        <div class="dashboard-card md:col-span-2 bg-background border rounded-2xl p-6">
            <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                <h3 class="text-lg font-bold text-foreground flex items-center gap-2">
                    {{template "icon-trending-up" dict "Size" 18}} Trajectoire
                </h3>
                <div class="dashboard-card flex items-center gap-4 bg-accent px-4 py-2 rounded-xl border w-full md:w-auto">
                    <span class="text-xs text-muted-foreground whitespace-nowrap font-medium">
                        Projection : <strong x-text="sliderValue + ' ans'">{{.Years}} ans</strong>
                    </span>
                    <input type="range" min="1" max="30"
                           x-model="sliderValue"
                           @change="htmx.trigger(document.body, 'sliderChange')"
                           class="w-full md:w-48 h-1.5 bg-slate-300 dark:bg-slate-700 rounded-lg appearance-none cursor-pointer accent-blue-600">
                </div>
            </div>
            <div class="h-[350px] w-full" id="projection-chart"
                 hx-get="/dashboard-partial?section=projection"
                 hx-trigger="sliderChange from:body"
                 hx-vals="js:{years: document.querySelector('[name=years]')?.value || 5}"
                 hx-swap="innerHTML">
                {{template "projection-chart" .}}
            </div>
        </div>

        <!-- Pie Chart -->
        <div class="dashboard-card bg-background border rounded-2xl p-6 flex flex-col">
            <h3 class="text-lg font-bold text-foreground mb-4 flex items-center gap-2">
                {{template "icon-dashboard" dict "Size" 18}} Repartition
            </h3>
            <div class="flex-1 min-h-[300px]" id="pie-chart">
                {{template "pie-chart" .}}
            </div>
        </div>
    </div>
</div>
{{end}}

{{define "kpi-cards"}}
<div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6">
    <div class="dashboard-card bg-background border p-6 rounded-2xl relative overflow-hidden transition-colors">
        <div class="absolute top-0 right-0 p-4 opacity-5 text-foreground">
            {{template "icon-shield-check" dict "Size" 80}}
        </div>
        <p class="text-xs text-muted-foreground font-bold uppercase tracking-wider mb-2">Patrimoine Net</p>
        <h2 class="text-3xl md:text-4xl font-bold text-foreground font-mono tracking-tight">{{formatMoney .TotalBalance}}</h2>
    </div>
    <div class="dashboard-card bg-background border p-6 rounded-2xl relative overflow-hidden transition-colors">
        <div class="absolute top-0 right-0 p-4 opacity-5 text-foreground">
            {{template "icon-trending-up" dict "Size" 80}}
        </div>
        <p class="text-xs text-muted-foreground font-bold uppercase tracking-wider mb-2">Interets Composes</p>
        <h2 class="text-3xl md:text-4xl font-bold text-emerald-500 font-mono tracking-tight">+{{formatMoney .TotalInterests}}</h2>
    </div>
    <div class="dashboard-card bg-background border p-6 rounded-2xl relative overflow-hidden transition-colors sm:col-span-2 md:col-span-1">
        <div class="absolute top-0 right-0 p-4 opacity-5 text-foreground">
            {{template "icon-piggybank" dict "Size" 80}}
        </div>
        <p class="text-xs text-muted-foreground font-bold uppercase tracking-wider mb-2">Projection a {{.Years}} ans</p>
        <h2 class="text-3xl md:text-4xl font-bold text-blue-500 font-mono tracking-tight">{{formatMoney .ProjectionTotal}}</h2>
    </div>
</div>
{{end}}

{{define "dashboard-cards"}}
{{template "kpi-cards" .}}
{{end}}

{{define "projection-chart"}}
<div class="h-full w-full">
    <canvas id="projectionCanvas"></canvas>
</div>
<script>
(function() {
    const ctx = document.getElementById('projectionCanvas');
    if (!ctx || typeof Chart === 'undefined') return;

    // Detruire le graphique existant si present
    if (window.projectionChart) {
        window.projectionChart.destroy();
    }

    const data = {{.ProjectionData | json}};

    if (!data || data.length === 0) {
        ctx.parentElement.innerHTML = '<div class="h-full flex items-center justify-center text-muted-foreground">Aucune donnee</div>';
        return;
    }

    const isDark = document.documentElement.classList.contains('dark');
    const gridColor = isDark ? 'rgba(148, 163, 184, 0.1)' : 'rgba(100, 116, 139, 0.1)';
    const textColor = isDark ? '#94a3b8' : '#64748b';

    window.projectionChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.map(d => d.name || ('An ' + d.year)),
            datasets: [{
                label: 'Projection moyenne',
                data: data.map(d => d.totalAvg),
                borderColor: '#3b82f6',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.3,
                pointRadius: 4,
                pointBackgroundColor: '#3b82f6',
                pointBorderColor: isDark ? '#0f172a' : '#ffffff',
                pointBorderWidth: 2,
                pointHoverRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                intersect: false,
                mode: 'index'
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: isDark ? '#1e293b' : '#ffffff',
                    titleColor: isDark ? '#f1f5f9' : '#0f172a',
                    bodyColor: isDark ? '#cbd5e1' : '#475569',
                    borderColor: isDark ? '#334155' : '#e2e8f0',
                    borderWidth: 1,
                    padding: 12,
                    displayColors: false,
                    callbacks: {
                        label: function(context) {
                            return new Intl.NumberFormat('fr-FR', {
                                style: 'currency',
                                currency: 'EUR',
                                maximumFractionDigits: 0
                            }).format(context.raw);
                        }
                    }
                }
            },
            scales: {
                x: {
                    grid: {
                        color: gridColor,
                        drawBorder: false
                    },
                    ticks: {
                        color: textColor,
                        font: { size: 11 }
                    }
                },
                y: {
                    beginAtZero: true,
                    grid: {
                        color: gridColor,
                        drawBorder: false
                    },
                    ticks: {
                        color: textColor,
                        font: { size: 11 },
                        callback: function(value) {
                            return new Intl.NumberFormat('fr-FR', {
                                style: 'currency',
                                currency: 'EUR',
                                notation: 'compact',
                                maximumFractionDigits: 0
                            }).format(value);
                        }
                    }
                }
            }
        }
    });
})();
</script>
{{end}}

{{define "pie-chart"}}
<div class="h-full w-full flex flex-col items-center justify-center">
    <div class="relative w-full max-w-[250px]" style="aspect-ratio: 1;">
        <canvas id="pieCanvas"></canvas>
        <div class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
            <div class="text-2xl font-bold font-mono text-foreground">{{formatMoney .TotalBalance}}</div>
            <div class="text-xs text-muted-foreground uppercase font-bold">Total</div>
        </div>
    </div>
    <div id="pieLegend" class="mt-4 flex flex-wrap justify-center gap-2"></div>
</div>
<script>
(function() {
    const ctx = document.getElementById('pieCanvas');
    if (!ctx || typeof Chart === 'undefined') return;

    // Detruire le graphique existant si present
    if (window.pieChart) {
        window.pieChart.destroy();
    }

    const accounts = {{.PieData | json}};
    const isDark = document.documentElement.classList.contains('dark');

    if (!accounts || accounts.length === 0) {
        ctx.parentElement.querySelector('.absolute').innerHTML = `
            <div class="text-muted-foreground text-sm">Aucun compte</div>
        `;
        return;
    }

    window.pieChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: accounts.map(a => a.name),
            datasets: [{
                data: accounts.map(a => a.value),
                backgroundColor: accounts.map(a => a.color),
                borderColor: isDark ? '#0f172a' : '#ffffff',
                borderWidth: 3,
                hoverOffset: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            cutout: '65%',
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: isDark ? '#1e293b' : '#ffffff',
                    titleColor: isDark ? '#f1f5f9' : '#0f172a',
                    bodyColor: isDark ? '#cbd5e1' : '#475569',
                    borderColor: isDark ? '#334155' : '#e2e8f0',
                    borderWidth: 1,
                    padding: 12,
                    callbacks: {
                        label: function(context) {
                            const value = new Intl.NumberFormat('fr-FR', {
                                style: 'currency',
                                currency: 'EUR',
                                maximumFractionDigits: 0
                            }).format(context.raw);
                            const percent = ((context.raw / context.dataset.data.reduce((a, b) => a + b, 0)) * 100).toFixed(1);
                            return `${value} (${percent}%)`;
                        }
                    }
                }
            }
        }
    });

    // Legende personnalisee
    const legendContainer = document.getElementById('pieLegend');
    if (legendContainer) {
        legendContainer.innerHTML = accounts.map(a => `
            <div class="flex items-center gap-1.5 text-xs">
                <span class="w-2.5 h-2.5 rounded-full" style="background-color: ${a.color}"></span>
                <span class="text-muted-foreground">${a.name}</span>
            </div>
        `).join('');
    }
})();
</script>
{{end}}
