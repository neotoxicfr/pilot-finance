<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#0f172a" media="(prefers-color-scheme: dark)">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Pilot">
    <title>{{if .Title}}{{.Title}} - {{end}}Pilot Finance</title>
    <meta name="description" content="Cockpit financier personnel">
    <link rel="icon" href="/static/favicon.ico" sizes="any">
    <link rel="icon" href="/static/logo.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="/static/apple-icon.png">
    <link rel="manifest" href="/static/manifest.json">
    <script>
        // Theme initial sans flash
        (function() {
            const stored = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const isDark = stored === 'dark' || (stored !== 'light' && prefersDark);
            if (isDark) document.documentElement.classList.add('dark');
        })();

        // Theme data pour Alpine.js
        function themeData() {
            return {
                theme: localStorage.getItem('theme') || 'system',
                get isDark() {
                    if (this.theme === 'system') {
                        return window.matchMedia('(prefers-color-scheme: dark)').matches;
                    }
                    return this.theme === 'dark';
                },
                toggleTheme() {
                    if (this.theme === 'system') this.theme = 'light';
                    else if (this.theme === 'light') this.theme = 'dark';
                    else this.theme = 'system';
                    localStorage.setItem('theme', this.theme);
                    document.documentElement.classList.toggle('dark', this.isDark);
                },
                init() {
                    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
                        if (this.theme === 'system') {
                            document.documentElement.classList.toggle('dark', this.isDark);
                        }
                    });
                }
            };
        }
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        background: 'var(--background)',
                        foreground: 'var(--foreground)',
                        border: 'var(--border)',
                        accent: 'var(--accent)',
                        'muted-foreground': 'var(--muted-foreground)',
                    }
                }
            }
        }
    </script>
    <link rel="stylesheet" href="/static/css/app.css">
    <script src="https://unpkg.com/htmx.org@2.0.4" integrity="sha384-HGfztofotfshcF7+8n44JQL2oJmowVChPTg48S+jvZoztPfvwD79OC/LTtG6dMp+" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script defer src="https://unpkg.com/alpinejs@3.14.8/dist/cdn.min.js"></script>
    <script src="/static/js/passkey.js"></script>
</head>
<body class="font-sans antialiased min-h-screen flex flex-col bg-background text-foreground" x-data="themeData()" x-init="init()">
    {{if .User}}
    <nav class="border-b border-border bg-background/50 backdrop-blur-md sticky top-0 z-50">
        <div class="max-w-[1400px] mx-auto px-2 sm:px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3 sm:gap-8">
                <a href="/" class="hover:opacity-80 transition-opacity flex-shrink-0">
                    {{template "brand-logo" dict "Size" 28}}
                </a>
                <div class="flex items-center gap-1">
                    <a href="/" class="flex items-center gap-2 px-2 py-2 text-sm font-medium text-foreground/70 hover:text-foreground hover:bg-accent rounded-lg transition-all">
                        {{template "icon-dashboard" dict "Size" 20}}
                        <span class="hidden lg:inline">Dashboard</span>
                    </a>
                    <a href="/accounts" class="flex items-center gap-2 px-2 py-2 text-sm font-medium text-foreground/70 hover:text-foreground hover:bg-accent rounded-lg transition-all">
                        {{template "icon-wallet" dict "Size" 20}}
                        <span class="hidden lg:inline">Comptes</span>
                    </a>
                </div>
            </div>
            <div class="flex items-center gap-1 sm:gap-2">
                <button @click="toggleTheme()" class="p-2 text-muted-foreground hover:text-foreground hover:bg-accent rounded-full transition-all" :title="'Theme: ' + theme">
                    <span x-show="theme === 'light'" x-cloak>{{template "icon-sun" dict "Size" 20}}</span>
                    <span x-show="theme === 'dark'" x-cloak>{{template "icon-moon" dict "Size" 20}}</span>
                    <span x-show="theme === 'system'" x-cloak>{{template "icon-monitor" dict "Size" 20}}</span>
                </button>
                <div class="h-4 w-px bg-border mx-0.5"></div>
                <a href="/settings" class="p-2 text-muted-foreground hover:text-foreground hover:bg-accent rounded-full transition-all">
                    {{template "icon-settings" dict "Size" 20}}
                </a>
                <div class="h-4 w-px bg-border mx-0.5"></div>
                <form action="/logout" method="POST">
                    <button type="submit" class="p-2 text-muted-foreground hover:text-red-500 hover:bg-red-500/10 rounded-full transition-all">
                        {{template "icon-logout" dict "Size" 20}}
                    </button>
                </form>
            </div>
        </div>
    </nav>
    {{end}}
    <main class="flex-1">
        {{template "content" .}}
    </main>
    {{template "htmx-config"}}
</body>
</html>

{{define "htmx-config"}}
<script>
document.body.addEventListener('htmx:beforeSwap', function(evt) {
    if (evt.detail.xhr.status === 401) {
        window.location.href = '/login';
    }
});

// Initialisation du graphique de projection
window.initProjectionChart = function() {
    const ctx = document.getElementById('projectionCanvas');
    const dataEl = document.getElementById('projection-data');
    if (!ctx || !dataEl || typeof Chart === 'undefined') return;

    if (window.projectionChart) {
        window.projectionChart.destroy();
        window.projectionChart = null;
    }

    let data;
    try {
        data = JSON.parse(dataEl.textContent);
    } catch(e) {
        console.error('Invalid projection data:', e);
        return;
    }

    if (!data || data.length === 0) {
        ctx.parentElement.innerHTML = '<div class="h-full flex items-center justify-center text-muted-foreground">Aucune donnee</div>';
        return;
    }

    const isDark = document.documentElement.classList.contains('dark');
    const gridColor = isDark ? 'rgba(148, 163, 184, 0.1)' : 'rgba(100, 116, 139, 0.1)';
    const textColor = isDark ? '#94a3b8' : '#64748b';

    window.projectionChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.map(d => d.name || ('An ' + d.year)),
            datasets: [{
                label: 'Projection moyenne',
                data: data.map(d => d.totalAvg),
                borderColor: '#3b82f6',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.3,
                pointRadius: 4,
                pointBackgroundColor: '#3b82f6',
                pointBorderColor: isDark ? '#0f172a' : '#ffffff',
                pointBorderWidth: 2,
                pointHoverRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { intersect: false, mode: 'index' },
            plugins: {
                legend: { display: false },
                tooltip: {
                    backgroundColor: isDark ? '#1e293b' : '#ffffff',
                    titleColor: isDark ? '#f1f5f9' : '#0f172a',
                    bodyColor: isDark ? '#cbd5e1' : '#475569',
                    borderColor: isDark ? '#334155' : '#e2e8f0',
                    borderWidth: 1,
                    padding: 12,
                    displayColors: false,
                    callbacks: {
                        label: function(context) {
                            return new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 }).format(context.raw);
                        }
                    }
                }
            },
            scales: {
                x: { grid: { color: gridColor, drawBorder: false }, ticks: { color: textColor, font: { size: 11 } } },
                y: {
                    beginAtZero: true,
                    grid: { color: gridColor, drawBorder: false },
                    ticks: {
                        color: textColor,
                        font: { size: 11 },
                        callback: function(value) {
                            return new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR', notation: 'compact', maximumFractionDigits: 0 }).format(value);
                        }
                    }
                }
            }
        }
    });
};

// Initialisation du camembert
window.initPieChart = function() {
    const ctx = document.getElementById('pieCanvas');
    const dataEl = document.getElementById('pie-data');
    if (!ctx || !dataEl || typeof Chart === 'undefined') return;

    if (window.pieChart) {
        window.pieChart.destroy();
        window.pieChart = null;
    }

    let accounts;
    try {
        accounts = JSON.parse(dataEl.textContent);
    } catch(e) {
        console.error('Invalid pie data:', e);
        return;
    }

    const isDark = document.documentElement.classList.contains('dark');

    if (!accounts || accounts.length === 0) {
        return;
    }

    window.pieChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: accounts.map(a => a.name),
            datasets: [{
                data: accounts.map(a => a.value),
                backgroundColor: accounts.map(a => a.color),
                borderColor: isDark ? '#0f172a' : '#ffffff',
                borderWidth: 3,
                hoverOffset: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            cutout: '65%',
            plugins: {
                legend: { display: false },
                tooltip: {
                    backgroundColor: isDark ? '#1e293b' : '#ffffff',
                    titleColor: isDark ? '#f1f5f9' : '#0f172a',
                    bodyColor: isDark ? '#cbd5e1' : '#475569',
                    borderColor: isDark ? '#334155' : '#e2e8f0',
                    borderWidth: 1,
                    padding: 12,
                    callbacks: {
                        label: function(context) {
                            const value = new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 }).format(context.raw);
                            const percent = ((context.raw / context.dataset.data.reduce((a, b) => a + b, 0)) * 100).toFixed(1);
                            return value + ' (' + percent + '%)';
                        }
                    }
                }
            }
        }
    });

    const legendContainer = document.getElementById('pieLegend');
    if (legendContainer) {
        legendContainer.innerHTML = accounts.map(a =>
            '<div class="flex items-center gap-1.5 text-xs"><span class="w-2.5 h-2.5 rounded-full" style="background-color: ' + a.color + '"></span><span class="text-muted-foreground">' + a.name + '</span></div>'
        ).join('');
    }
};

// Initialiser les charts au chargement de la page
document.addEventListener('DOMContentLoaded', function() {
    window.initProjectionChart && window.initProjectionChart();
    window.initPieChart && window.initPieChart();
});
</script>
{{end}}
