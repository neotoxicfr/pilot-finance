<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#0f172a" media="(prefers-color-scheme: dark)">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Pilot">
    <title>{{if .Title}}{{.Title}} - {{end}}Pilot Finance</title>
    <meta name="description" content="Cockpit financier personnel">
    <link rel="icon" href="/static/favicon.ico" sizes="any">
    <link rel="icon" href="/static/logo.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="/static/apple-icon.png">
    <link rel="manifest" href="/static/manifest.json">
    <script>
        // Theme initial sans flash
        (function() {
            const stored = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const html = document.documentElement;
            if (stored === 'dark') {
                html.classList.add('dark');
            } else if (stored === 'light') {
                html.classList.add('light');
            } else if (prefersDark) {
                html.classList.add('dark');
            }
        })();

        // Theme data pour Alpine.js
        function themeData() {
            return {
                theme: localStorage.getItem('theme') || 'system',
                get isDark() {
                    if (this.theme === 'system') {
                        return window.matchMedia('(prefers-color-scheme: dark)').matches;
                    }
                    return this.theme === 'dark';
                },
                applyTheme() {
                    const html = document.documentElement;
                    html.classList.remove('dark', 'light');
                    if (this.theme === 'dark') {
                        html.classList.add('dark');
                    } else if (this.theme === 'light') {
                        html.classList.add('light');
                    } else if (this.isDark) {
                        html.classList.add('dark');
                    }
                },
                toggleTheme() {
                    if (this.theme === 'system') this.theme = 'light';
                    else if (this.theme === 'light') this.theme = 'dark';
                    else this.theme = 'system';
                    localStorage.setItem('theme', this.theme);
                    this.applyTheme();
                },
                init() {
                    this.applyTheme();
                    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
                        if (this.theme === 'system') {
                            this.applyTheme();
                        }
                    });
                }
            };
        }
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        background: 'var(--background)',
                        foreground: 'var(--foreground)',
                        border: 'var(--border)',
                        accent: 'var(--accent)',
                        'muted-foreground': 'var(--muted-foreground)',
                    }
                }
            }
        }
    </script>
    <link rel="stylesheet" href="/static/css/app.css">
    <script src="https://unpkg.com/htmx.org@2.0.8/dist/htmx.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.5.1/dist/chart.umd.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.15.3/dist/cdn.min.js"></script>
    <script src="/static/js/passkey.js"></script>
</head>
<body class="font-sans antialiased min-h-screen flex flex-col bg-background text-foreground" x-data="themeData()" x-init="init()">
    {{if .User}}
    <nav class="border-b border-border bg-background/50 backdrop-blur-md sticky top-0 z-50">
        <div class="max-w-[1400px] mx-auto px-2 sm:px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3 sm:gap-8">
                <a href="/" class="hover:opacity-80 transition-opacity flex-shrink-0">
                    {{template "brand-logo" dict "Size" 28}}
                </a>
                <div class="flex items-center gap-1">
                    <a href="/" class="flex items-center gap-2 px-2 py-2 text-sm font-medium text-foreground/70 hover:text-foreground hover:bg-accent rounded-lg transition-all">
                        {{template "icon-dashboard" dict "Size" 20}}
                        <span class="hidden lg:inline">Dashboard</span>
                    </a>
                    <a href="/accounts" class="flex items-center gap-2 px-2 py-2 text-sm font-medium text-foreground/70 hover:text-foreground hover:bg-accent rounded-lg transition-all">
                        {{template "icon-wallet" dict "Size" 20}}
                        <span class="hidden lg:inline">Comptes</span>
                    </a>
                </div>
            </div>
            <div class="flex items-center gap-1 sm:gap-2">
                <button @click="toggleTheme()" class="p-2 text-muted-foreground hover:text-foreground hover:bg-accent rounded-full transition-all" :title="'Theme: ' + theme">
                    <span x-show="theme === 'light'" x-cloak>{{template "icon-sun" dict "Size" 20}}</span>
                    <span x-show="theme === 'dark'" x-cloak>{{template "icon-moon" dict "Size" 20}}</span>
                    <span x-show="theme === 'system'" x-cloak>{{template "icon-monitor" dict "Size" 20}}</span>
                </button>
                <div class="h-4 w-px bg-border mx-0.5"></div>
                <a href="/settings" class="p-2 text-muted-foreground hover:text-foreground hover:bg-accent rounded-full transition-all">
                    {{template "icon-settings" dict "Size" 20}}
                </a>
                <div class="h-4 w-px bg-border mx-0.5"></div>
                <form action="/logout" method="POST">
                    <button type="submit" class="p-2 text-muted-foreground hover:text-red-500 hover:bg-red-500/10 rounded-full transition-all">
                        {{template "icon-logout" dict "Size" 20}}
                    </button>
                </form>
            </div>
        </div>
    </nav>
    {{end}}
    <main class="flex-1">
        {{template "content" .}}
    </main>
    {{template "htmx-config"}}
</body>
</html>

{{define "htmx-config"}}
<script>
document.body.addEventListener('htmx:beforeSwap', function(evt) {
    if (evt.detail.xhr.status === 401) {
        window.location.href = '/login';
    }
});

// Couleurs et options communes pour les charts
function getChartColors() {
    const isDark = document.documentElement.classList.contains('dark');
    return {
        isDark,
        gridColor: isDark ? 'rgba(148, 163, 184, 0.1)' : 'rgba(100, 116, 139, 0.1)',
        textColor: isDark ? '#94a3b8' : '#64748b',
        tooltipBg: isDark ? '#1e293b' : '#ffffff',
        tooltipTitle: isDark ? '#f1f5f9' : '#0f172a',
        tooltipBody: isDark ? '#cbd5e1' : '#475569',
        tooltipBorder: isDark ? '#334155' : '#e2e8f0'
    };
}

// Creer les datasets pour le graphique de projection
function createProjectionDatasets(data, accountColors) {
    if (accountColors && accountColors.length > 0 && data[0] && data[0].accounts) {
        return accountColors.map(acc => ({
            label: acc.name,
            data: data.map(d => d.accounts ? (d.accounts[acc.name] || 0) : 0),
            backgroundColor: acc.color,
            borderWidth: 0,
            fill: true,
            tension: 0.3,
            pointRadius: 0,
            pointHoverRadius: 4,
            pointBackgroundColor: acc.color,
            pointBorderWidth: 0
        }));
    }
    return [{
        label: 'Projection moyenne',
        data: data.map(d => d.totalAvg),
        backgroundColor: '#3b82f6',
        borderWidth: 0,
        fill: true,
        tension: 0.3,
        pointRadius: 0,
        pointHoverRadius: 4,
        pointBackgroundColor: '#3b82f6',
        pointBorderWidth: 0
    }];
}

// Initialisation du graphique de projection
window.initProjectionChart = function(data, accountColors) {
    const ctx = document.getElementById('projectionCanvas');
    if (!ctx || typeof Chart === 'undefined') return;

    if (window.projectionChart) {
        window.projectionChart.destroy();
        window.projectionChart = null;
    }

    if (!data || data.length === 0) {
        ctx.parentElement.innerHTML = '<div class="h-full flex items-center justify-center text-muted-foreground">Aucune donnee</div>';
        return;
    }

    const colors = getChartColors();
    const datasets = createProjectionDatasets(data, accountColors);

    window.projectionChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.map(d => d.name || ('An ' + d.year)),
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: { duration: 400, easing: 'easeOutQuart' },
            interaction: { intersect: false, mode: 'index' },
            plugins: {
                legend: { display: accountColors && accountColors.length > 1 },
                tooltip: {
                    backgroundColor: colors.tooltipBg,
                    titleColor: colors.tooltipTitle,
                    bodyColor: colors.tooltipBody,
                    borderColor: colors.tooltipBorder,
                    borderWidth: 1,
                    padding: 12,
                    callbacks: {
                        label: function(context) {
                            const value = new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 }).format(context.raw);
                            return context.dataset.label + ': ' + value;
                        },
                        footer: function(items) {
                            const total = items.reduce((sum, item) => sum + item.raw, 0);
                            return 'Total: ' + new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 }).format(total);
                        }
                    }
                }
            },
            scales: {
                x: {
                    grid: { color: colors.gridColor, drawBorder: false },
                    ticks: { color: colors.textColor, font: { size: 11 } }
                },
                y: {
                    stacked: accountColors && accountColors.length > 0,
                    beginAtZero: true,
                    grid: { color: colors.gridColor, drawBorder: false },
                    ticks: {
                        color: colors.textColor,
                        font: { size: 11 },
                        callback: function(value) {
                            if (value >= 1000000) return (value / 1000000).toFixed(1).replace('.0', '') + 'M €';
                            if (value >= 1000) return Math.round(value / 1000) + 'k €';
                            return value + ' €';
                        }
                    }
                }
            }
        }
    });
};

// Mise a jour du graphique de projection (transitions fluides)
window.updateProjectionChart = function(data, accountColors) {
    if (!window.projectionChart || !data || data.length === 0) {
        window.initProjectionChart(data, accountColors);
        return;
    }

    const chart = window.projectionChart;
    const newLabels = data.map(d => d.name || ('An ' + d.year));
    const newDatasets = createProjectionDatasets(data, accountColors);

    chart.data.labels = newLabels;
    newDatasets.forEach((ds, i) => {
        if (chart.data.datasets[i]) {
            chart.data.datasets[i].data = ds.data;
        }
    });
    chart.update();
};

// Initialisation du camembert
window.initPieChart = function(accounts) {
    const ctx = document.getElementById('pieCanvas');
    if (!ctx || typeof Chart === 'undefined') return;

    if (window.pieChart) {
        window.pieChart.destroy();
        window.pieChart = null;
    }

    if (!accounts || accounts.length === 0) return;

    const colors = getChartColors();
    const bgColors = accounts.map(a => a.color);
    // Recuperer la couleur de fond via CSS pour l'espacement
    const cardBg = getComputedStyle(document.documentElement).getPropertyValue('--background').trim();

    window.pieChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: accounts.map(a => a.name),
            datasets: [{
                data: accounts.map(a => a.value),
                backgroundColor: bgColors,
                borderColor: cardBg,
                borderWidth: 2,
                hoverOffset: 0,
                hoverBorderColor: cardBg,
                hoverBorderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            cutout: '65%',
            animation: { duration: 400, easing: 'easeOutQuart' },
            plugins: {
                legend: { display: false },
                tooltip: {
                    enabled: false,
                    external: function(context) {
                        let tooltip = document.getElementById('pie-tooltip');
                        if (!tooltip) {
                            tooltip = document.createElement('div');
                            tooltip.id = 'pie-tooltip';
                            tooltip.style.cssText = 'position:fixed;pointer-events:none;padding:8px 12px;border-radius:8px;font-size:13px;z-index:9999;transition:opacity 0.15s;';
                            document.body.appendChild(tooltip);
                        }
                        const tooltipModel = context.tooltip;
                        if (tooltipModel.opacity === 0) {
                            tooltip.style.opacity = 0;
                            return;
                        }
                        const currentColors = getChartColors();
                        const data = tooltipModel.dataPoints[0];
                        const value = new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 }).format(data.raw);
                        const total = data.dataset.data.reduce((a, b) => a + b, 0);
                        const percent = ((data.raw / total) * 100).toFixed(1);
                        tooltip.innerHTML = '<strong>' + data.label + '</strong><br>' + value + ' (' + percent + '%)';
                        tooltip.style.backgroundColor = currentColors.tooltipBg;
                        tooltip.style.color = currentColors.tooltipBody;
                        tooltip.style.border = '1px solid ' + currentColors.tooltipBorder;
                        tooltip.style.opacity = 1;
                        const canvasRect = context.chart.canvas.getBoundingClientRect();
                        tooltip.style.left = (canvasRect.left + tooltipModel.caretX + 10) + 'px';
                        tooltip.style.top = (canvasRect.top + tooltipModel.caretY - 10) + 'px';
                    }
                }
            }
        }
    });

    const legendContainer = document.getElementById('pieLegend');
    if (legendContainer) {
        legendContainer.innerHTML = accounts.map(a =>
            '<div class="flex items-center gap-1.5 text-xs"><span class="w-2.5 h-2.5 rounded-full" style="background-color: ' + a.color + '"></span><span class="text-muted-foreground">' + a.name + '</span></div>'
        ).join('');
    }
};
</script>
{{end}}
