<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#0f172a" media="(prefers-color-scheme: dark)">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Pilot">
    <title>{{if .Title}}{{.Title}} - {{end}}Pilot Finance</title>
    <meta name="description" content="Cockpit financier personnel">
    <link rel="icon" href="/static/favicon.ico" sizes="any">
    <link rel="icon" href="/static/logo.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="/static/apple-icon.png">
    <link rel="manifest" href="/static/manifest.json">
    <script>
        // Theme initial sans flash
        (function() {
            const stored = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const html = document.documentElement;
            if (stored === 'dark') {
                html.classList.add('dark');
            } else if (stored === 'light') {
                html.classList.add('light');
            } else if (prefersDark) {
                html.classList.add('dark');
            }
        })();

        // Theme data pour Alpine.js
        function themeData() {
            return {
                theme: localStorage.getItem('theme') || 'system',
                get isDark() {
                    if (this.theme === 'system') {
                        return window.matchMedia('(prefers-color-scheme: dark)').matches;
                    }
                    return this.theme === 'dark';
                },
                applyTheme() {
                    const html = document.documentElement;
                    html.classList.remove('dark', 'light');
                    if (this.theme === 'dark') {
                        html.classList.add('dark');
                    } else if (this.theme === 'light') {
                        html.classList.add('light');
                    } else if (this.isDark) {
                        html.classList.add('dark');
                    }
                },
                toggleTheme() {
                    if (this.theme === 'system') this.theme = 'light';
                    else if (this.theme === 'light') this.theme = 'dark';
                    else this.theme = 'system';
                    localStorage.setItem('theme', this.theme);
                    this.applyTheme();
                },
                init() {
                    this.applyTheme();
                    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
                        if (this.theme === 'system') {
                            this.applyTheme();
                        }
                    });
                }
            };
        }
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        background: 'var(--background)',
                        foreground: 'var(--foreground)',
                        border: 'var(--border)',
                        accent: 'var(--accent)',
                        'muted-foreground': 'var(--muted-foreground)',
                    }
                }
            }
        }
    </script>
    <link rel="stylesheet" href="/static/css/app.css">
    <script src="https://unpkg.com/htmx.org@2.0.8/dist/htmx.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.5.1/dist/chart.umd.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.15.3/dist/cdn.min.js"></script>
    <script src="/static/js/passkey.js"></script>
</head>
<body class="font-sans antialiased min-h-screen flex flex-col bg-background text-foreground" x-data="themeData()" x-init="init()">
    {{if .User}}
    <nav class="border-b border-border bg-background/50 backdrop-blur-md sticky top-0 z-50">
        <div class="max-w-[1400px] mx-auto px-2 sm:px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3 sm:gap-8">
                <a href="/" class="hover:opacity-80 transition-opacity flex-shrink-0">
                    {{template "brand-logo" dict "Size" 28}}
                </a>
                <div class="flex items-center gap-1">
                    <a href="/" class="flex items-center gap-2 px-2 py-2 text-sm font-medium text-foreground/70 hover:text-foreground hover:bg-accent rounded-lg transition-all">
                        {{template "icon-dashboard" dict "Size" 20}}
                        <span class="hidden lg:inline">Dashboard</span>
                    </a>
                    <a href="/accounts" class="flex items-center gap-2 px-2 py-2 text-sm font-medium text-foreground/70 hover:text-foreground hover:bg-accent rounded-lg transition-all">
                        {{template "icon-wallet" dict "Size" 20}}
                        <span class="hidden lg:inline">Comptes</span>
                    </a>
                </div>
            </div>
            <div class="flex items-center gap-1 sm:gap-2">
                <button @click="toggleTheme()" class="p-2 text-muted-foreground hover:text-foreground hover:bg-accent rounded-full transition-all" :title="'Theme: ' + theme">
                    <span x-show="theme === 'light'" x-cloak>{{template "icon-sun" dict "Size" 20}}</span>
                    <span x-show="theme === 'dark'" x-cloak>{{template "icon-moon" dict "Size" 20}}</span>
                    <span x-show="theme === 'system'" x-cloak>{{template "icon-monitor" dict "Size" 20}}</span>
                </button>
                <div class="h-4 w-px bg-border mx-0.5"></div>
                <a href="/settings" class="p-2 text-muted-foreground hover:text-foreground hover:bg-accent rounded-full transition-all">
                    {{template "icon-settings" dict "Size" 20}}
                </a>
                <div class="h-4 w-px bg-border mx-0.5"></div>
                <form action="/logout" method="POST">
                    <button type="submit" class="p-2 text-muted-foreground hover:text-red-500 hover:bg-red-500/10 rounded-full transition-all">
                        {{template "icon-logout" dict "Size" 20}}
                    </button>
                </form>
            </div>
        </div>
    </nav>
    {{end}}
    <main class="flex-1">
        {{template "content" .}}
    </main>
    {{template "htmx-config"}}
</body>
</html>

{{define "htmx-config"}}
<script>
document.body.addEventListener('htmx:beforeSwap', e => { if (e.detail.xhr.status === 401) location.href = '/login'; });

// Utilitaires
const fmt = v => new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 }).format(v);
const fmtAxis = v => v >= 1e6 ? (v/1e6).toFixed(1).replace('.0','')+'M €' : v >= 1e3 ? Math.round(v/1e3)+'k €' : v+' €';
const getColors = () => {
    const d = document.documentElement.classList.contains('dark');
    return { isDark: d, grid: d ? 'rgba(148,163,184,.1)' : 'rgba(100,116,139,.1)', text: d ? '#94a3b8' : '#64748b', tipBg: d ? '#1e293b' : '#fff', tipTitle: d ? '#f1f5f9' : '#0f172a', tipBody: d ? '#cbd5e1' : '#475569', tipBorder: d ? '#334155' : '#e2e8f0' };
};
const dsOpts = (c) => ({ backgroundColor: c, borderWidth: 0, fill: true, tension: .3, pointRadius: 0, pointHoverRadius: 4, pointBackgroundColor: c, pointBorderWidth: 0 });

// Creer datasets projection
const createDS = (data, acc) => acc?.length && data[0]?.accounts ? acc.map(a => ({ label: a.name, data: data.map(d => d.accounts?.[a.name] || 0), ...dsOpts(a.color) })) : [{ label: 'Projection', data: data.map(d => d.totalAvg), ...dsOpts('#3b82f6') }];

// Chart projection
window.initProjectionChart = (data, acc) => {
    const ctx = document.getElementById('projectionCanvas');
    if (!ctx || typeof Chart === 'undefined') return;
    window.projectionChart?.destroy();
    if (!data?.length) { ctx.parentElement.innerHTML = '<div class="h-full flex items-center justify-center text-muted-foreground">Aucune donnee</div>'; return; }
    const c = getColors();
    window.projectionChart = new Chart(ctx, {
        type: 'line',
        data: { labels: data.map(d => d.name || 'An '+d.year), datasets: createDS(data, acc) },
        options: {
            responsive: true, maintainAspectRatio: false, animation: { duration: 400, easing: 'easeOutQuart' }, interaction: { intersect: false, mode: 'index' },
            plugins: { legend: { display: acc?.length > 1 }, tooltip: { backgroundColor: c.tipBg, titleColor: c.tipTitle, bodyColor: c.tipBody, borderColor: c.tipBorder, borderWidth: 1, padding: 12, callbacks: { label: ctx => ctx.dataset.label+': '+fmt(ctx.raw), footer: items => 'Total: '+fmt(items.reduce((s,i) => s+i.raw, 0)) } } },
            scales: { x: { grid: { color: c.grid, drawBorder: false }, ticks: { color: c.text, font: { size: 11 } } }, y: { stacked: acc?.length > 0, beginAtZero: true, grid: { color: c.grid, drawBorder: false }, ticks: { color: c.text, font: { size: 11 }, callback: fmtAxis } } }
        }
    });
};

window.updateProjectionChart = (data, acc) => {
    if (!window.projectionChart || !data?.length) { window.initProjectionChart(data, acc); return; }
    const ch = window.projectionChart;
    ch.data.labels = data.map(d => d.name || 'An '+d.year);
    createDS(data, acc).forEach((ds, i) => { if (ch.data.datasets[i]) ch.data.datasets[i].data = ds.data; });
    ch.update();
};

// Chart camembert
window.initPieChart = accounts => {
    const ctx = document.getElementById('pieCanvas');
    if (!ctx || typeof Chart === 'undefined') return;
    window.pieChart?.destroy();
    if (!accounts?.length) return;
    const c = getColors(), bg = getComputedStyle(document.documentElement).getPropertyValue('--background').trim();
    window.pieChart = new Chart(ctx, {
        type: 'doughnut',
        data: { labels: accounts.map(a => a.name), datasets: [{ data: accounts.map(a => a.value), backgroundColor: accounts.map(a => a.color), borderColor: bg, borderWidth: 2, hoverOffset: 0, hoverBorderColor: bg, hoverBorderWidth: 2 }] },
        options: {
            responsive: true, maintainAspectRatio: true, cutout: '65%', animation: { duration: 400, easing: 'easeOutQuart' },
            plugins: { legend: { display: false }, tooltip: { enabled: false, external: ctx => {
                let t = document.getElementById('pie-tooltip');
                if (!t) { t = document.createElement('div'); t.id = 'pie-tooltip'; t.style.cssText = 'position:fixed;pointer-events:none;padding:8px 12px;border-radius:8px;font-size:13px;z-index:9999;transition:opacity .15s'; document.body.appendChild(t); }
                const tm = ctx.tooltip;
                if (!tm.opacity) { t.style.opacity = 0; return; }
                const cc = getColors(), d = tm.dataPoints[0], total = d.dataset.data.reduce((a,b) => a+b, 0);
                t.innerHTML = '<strong>'+d.label+'</strong><br>'+fmt(d.raw)+' ('+(d.raw/total*100).toFixed(1)+'%)';
                Object.assign(t.style, { backgroundColor: cc.tipBg, color: cc.tipBody, border: '1px solid '+cc.tipBorder, opacity: 1, left: (ctx.chart.canvas.getBoundingClientRect().left+tm.caretX+10)+'px', top: (ctx.chart.canvas.getBoundingClientRect().top+tm.caretY-10)+'px' });
            } } }
        }
    });
    const leg = document.getElementById('pieLegend');
    if (leg) leg.innerHTML = accounts.map(a => '<div class="flex items-center gap-1.5 text-xs"><span class="w-2.5 h-2.5 rounded-full" style="background:'+a.color+'"></span><span class="text-muted-foreground">'+a.name+'</span></div>').join('');
    window.pieChartData = accounts;
};

// Theme observer
(function() {
    let last = document.documentElement.classList.contains('dark');
    new MutationObserver(() => {
        const cur = document.documentElement.classList.contains('dark');
        if (cur !== last) { last = cur; window.pieChartData?.length && window.initPieChart(window.pieChartData); }
    }).observe(document.documentElement, { attributes: true, attributeFilter: ['class'] });
})();
</script>
{{end}}
